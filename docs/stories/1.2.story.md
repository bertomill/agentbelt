# Story 1.2: Database & Email Infrastructure

<!-- Source: Epic 1.2 from docs/prd/epic-details.md -->
<!-- Context: Setting up Supabase database and Resend email service for AgentBelt -->

## Status: Approved

**As a** developer,
**I want** to set up data storage and email services,
**so that** the application can capture leads and send notifications.

## Acceptance Criteria

1. Supabase project created with appropriate plan selection
2. Leads table schema created (id, name, email, company, message, created_at, source)
3. Database connection string added to environment variables
4. Supabase client configured in utils/supabase.js with proper TypeScript types
5. Resend.com account created and domain verified
6. Email API key configured in environment variables
7. Test database insert and email send operations successful

## Tasks / Subtasks

- [ ] **Supabase Database Setup** (AC: 1, 2, 3)
  - [ ] Verify Supabase project is accessible with current credentials
  - [ ] Create leads table with proper schema in Supabase dashboard
  - [ ] Set up Row Level Security (RLS) policies for leads table
  - [ ] Test database connection with environment variables

- [ ] **Supabase Client Configuration** (AC: 4)
  - [ ] Create lib/supabase.ts with TypeScript client configuration
  - [ ] Set up proper TypeScript types for leads table
  - [ ] Create database utility functions for lead operations
  - [ ] Add error handling for database operations

- [ ] **Email Service Setup** (AC: 5, 6)
  - [ ] Verify Resend account and domain configuration
  - [ ] Create lib/email.ts with Resend client setup
  - [ ] Configure email templates for lead notifications
  - [ ] Set up proper error handling for email operations

- [ ] **Integration Testing** (AC: 7)
  - [ ] Create test script to verify database insert operations
  - [ ] Create test script to verify email sending functionality
  - [ ] Test end-to-end lead capture and notification flow
  - [ ] Verify all operations work with production environment variables

## Dev Notes

### Database Schema Requirements
Based on Epic 1.2 acceptance criteria, the leads table needs:
```sql
CREATE TABLE leads (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  company TEXT,
  message TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  source TEXT DEFAULT 'website'
);
```

### Technology Stack Context
- **Supabase**: PostgreSQL database with real-time capabilities
- **Resend**: Modern email API for transactional emails
- **TypeScript**: Full type safety for database and email operations
- **Next.js App Router**: Server-side API routes for form handling

### Supabase Client Setup
Create `lib/supabase.ts` with proper configuration:
- Use `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` for client
- Use `SUPABASE_SERVICE_ROLE_KEY` for server-side operations
- Implement proper error handling and type safety

### Email Configuration
Set up `lib/email.ts` with:
- Resend client initialization using `RESEND_API_KEY`
- Email template for lead notifications
- Professional sender configuration (noreply@agentbelt.vercel.app)
- Proper error handling and logging

### Security Considerations
- Row Level Security (RLS) policies on leads table
- Input validation and sanitization
- Rate limiting for form submissions
- Secure API key handling

## Testing

### Database Testing
- [ ] Verify Supabase connection establishes successfully
- [ ] Test lead record insertion with all required fields
- [ ] Test lead record insertion with optional fields (company)
- [ ] Verify created_at timestamp is automatically set
- [ ] Test RLS policies prevent unauthorized access

### Email Testing
- [ ] Verify Resend API connection works
- [ ] Test email sending with valid lead data
- [ ] Test email template rendering with dynamic content
- [ ] Verify sender address configuration
- [ ] Test error handling for failed email sends

### Integration Testing
- [ ] End-to-end test: form submission → database insert → email notification
- [ ] Test with production environment variables
- [ ] Verify all error scenarios are handled gracefully

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-26 | 1.0 | Initial story creation for database and email setup | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results

_To be filled by QA agent after implementation_